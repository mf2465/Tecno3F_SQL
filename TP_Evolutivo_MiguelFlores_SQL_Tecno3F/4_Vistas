CREATE OR REPLACE VIEW ultimo_turno_trabajadores_ensayo AS
SELECT E.idEnsayo AS 'Nro_Ensayo', E.fecha AS 'Fecha', P.nombre AS 'Nombre' , P.apellido AS 'Apellido', P.legajo AS 'Legajo', P.funcion AS'Función'
FROM ensayo as E
LEFT JOIN personal as P
ON E.operador1 = P.idPersonal
WHERE P.funcion IN ('certificante','operario','ayudante')
order by E.fecha desc
limit 1;

select * from ultimo_turno_trabajadores_ensayo;

/*
Se crea una VISTA para obtener la lista de personas que participaron del úiltimo ensayo del Laboratorio,
para que puedan ser notificados por mail que entran en un ciclo de descanso de este tipo de trabajo 
por el período que indique la gerencia operativa ( cronograma de turno rotativo ).
*/


CREATE OR REPLACE VIEW ultimo_turno_trabajadores_ensayo AS
SELECT
    E.idEnsayo AS Nro_Ensayo, 
    E.fecha AS Fecha, 
    CONCAT(P1.nombre, ' ', P1.apellido) AS STAFF_1, 
    P1.legajo AS Legajo_1,
    P1.funcion AS Funcion_1,
    P1.mail AS mail_1,
    CONCAT(P2.nombre, ' ', P2.apellido) AS STAFF_2, 
    P2.legajo AS Legajo_2,
    P2.funcion AS Funcion_2,
    P2.mail AS mail_2,
    CONCAT(P3.nombre, ' ', P3.apellido) AS STAFF_3,
    P3.legajo AS Legajo_3,
    P3.funcion AS Funcion_3,
    P3.mail AS mail_3,
    CONCAT(P4.nombre, ' ', P4.apellido) AS STAFF_4, 
    P4.legajo AS Legajo_4,
    P4.funcion AS Funcion_4,
    P4.mail AS mail_4
FROM 
    ensayo AS E
LEFT JOIN personal AS P1 ON E.operador1 = P1.idPersonal
LEFT JOIN personal AS P2 ON E.operador2 = P2.idPersonal
LEFT JOIN personal AS P3 ON E.operador3 = P3.idPersonal
LEFT JOIN personal AS P4 ON E.operador4 = P4.idPersonal
ORDER BY E.fecha DESC
LIMIT 1;

SELECT * FROM ultimo_turno_trabajadores_ensayo;

select * from certificado where aptitud = 0;

CREATE OR REPLACE VIEW listado_elementos_rechazados_aviso_empresas AS
SELECT 
E.tipo_elemento AS 'Elemento', E.tag_original AS 'TAG_original', E.precinto AS 'Precinto_anterior', E.remito_in AS 'Remito_ingreso',
E.ficha_tecnica AS 'Ficha_tecnica', E.ensayo AS 'Ensayo', E.certificado AS 'Certificado',
C.aptitud AS 'Aptitud'
FROM elemento AS E
INNER JOIN certificado AS C 
ON E.certificado = C.idCertificado 
;

SELECT * FROM listado_elementos_rechazados_aviso_empresas where aptitud = 0;

CREATE OR REPLACE VIEW elementos_rechazados AS
SELECT 
    E.idElemento,
    E.tag_original,
    E.precinto,
    C.idCertificado AS Nro_Certificado,
    C.fecha AS Fecha,
    C.observaciones AS Observaciones,
    C.aptitud
FROM 
    elemento AS E
right JOIN 
    certificado AS C ON E.certificado = C.idCertificado
WHERE 
    C.aptitud < 1;
    
    select * from elementos_rechazados;
    
select count(idElemento) from elemento group by certificado;
